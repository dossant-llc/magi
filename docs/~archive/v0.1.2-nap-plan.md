# v0.1.2 "Nap" - Smart Memory Synthesis Plan

## **Core Philosophy**
Magi "takes a nap" to intelligently process and synthesize memories, moving beyond raw file dumps to contextually aware responses.

## **Technical Architecture**

### **Current Problem**
```javascript
// Current: Dumb file dumps
searchMemories(query) → [memory1.md, memory2.md, memory3.md] → raw dump

// Users see fragmented, contradictory, unprocessed information
```

### **v0.1.2 Solution**
```javascript
// Smart synthesis pipeline
searchMemories(query) → temporalAnalysis() → conflictDetection() → synthesize() → intelligent_response

// Users get coherent, temporally-aware, synthesized answers
```

## **Implementation Plan**

### **Phase 1: Enhanced Synthesis Engine**

#### **1.1 Improve AI Service Prompts**
- **File**: `services/brainbridge/src/services/ai-service.ts`
- **Changes**:
  - Add temporal context to synthesis prompts
  - Include contradiction detection instructions
  - Tune for conversational vs analytical response types
  - Leverage OpenAI (fast, high-quality synthesis)

#### **1.2 Temporal Intelligence**
```javascript
// Weight memories by recency
const temporalScore = (memory) => {
  const ageInDays = (Date.now() - memory.created) / (1000 * 60 * 60 * 24);
  return Math.exp(-ageInDays / 30); // Exponential decay over 30 days
};

// Prioritize recent memories in synthesis
const weightedMemories = memories.map(m => ({
  ...m,
  relevanceScore: m.relevanceScore * temporalScore(m)
})).sort((a, b) => b.relevanceScore - a.relevanceScore);
```

#### **1.3 Smart Response Classification**
```javascript
const classifyQuery = async (query) => {
  const prompt = `Classify this query:
  Query: "${query}"

  Respond with JSON:
  {
    "type": "question|list|analytical|lookup",
    "responseStyle": "conversational|structured|technical",
    "temporalSensitive": boolean
  }`;

  return await openai.complete(prompt);
};
```

### **Phase 2: Memory Consolidation Commands**

#### **2.1 "magi nap" Command Suite**
- **File**: `bin/magi` (add new commands)
- **Commands**:
  ```bash
  magi nap           # Quick memory analysis and insights
  magi nap --deep    # Full consolidation analysis
  magi nap status    # Show memory health and conflicts
  ```

#### **2.2 Consolidation Intelligence**
```javascript
const analyzeMemoryHealth = async (memories) => {
  const prompt = `Analyze these memories for:
  1. Fragmented topics (same subject across multiple files)
  2. Contradictory information (conflicting preferences/facts)
  3. Temporal evolution (how thoughts/preferences changed)

  Memories: ${JSON.stringify(memories)}

  Return analysis with specific recommendations.`;

  return await openai.complete(prompt);
};
```

### **Phase 3: Enhanced Memory Commands**

#### **3.1 Smarter REPL Commands**
- **File**: `dev/scripts/magi-repl.js`
- **New commands**:
  - `conflicts` - Show contradictory memories
  - `consolidate {topic}` - Merge related memories
  - `timeline {topic}` - Show how thoughts evolved

## **Technical Implementation Details**

### **LLM Integration Strategy**
- **Provider**: OpenAI (faster than local Ollama for development)
- **Models**:
  - `gpt-4o-mini` for classification/analysis (fast, cheap)
  - `gpt-4o` for complex synthesis (when needed)
- **Optimization**: Batch processing, smart caching

### **Temporal Weighting Algorithm**
```javascript
const calculateTemporalRelevance = (memories, query) => {
  return memories.map(memory => {
    const recencyScore = Math.exp(-memory.ageInDays / 30);
    const relevanceScore = memory.semanticSimilarity;
    const conflictPenalty = memory.hasConflicts ? 0.7 : 1.0;

    return {
      ...memory,
      finalScore: relevanceScore * recencyScore * conflictPenalty
    };
  }).sort((a, b) => b.finalScore - a.finalScore);
};
```

### **Synthesis Prompt Templates**
```javascript
const SYNTHESIS_PROMPTS = {
  conversational: `You are synthesizing memories to answer: "${query}"

    Consider temporal context - newer information overrides older contradictions.

    Memories (newest first):
    ${memories.map(m => `[${m.date}] ${m.content}`).join('\n')}

    Provide a conversational, coherent response that:
    1. Acknowledges evolution of thoughts if present
    2. Prioritizes recent information
    3. Notes contradictions when relevant`,

  analytical: `Analyze these memories to answer: "${query}"

    Provide structured analysis with:
    1. Current consensus/truth
    2. Historical changes/evolution
    3. Conflicting information (with dates)
    4. Confidence level in conclusions`
};
```

## **Success Criteria**

### **v0.1.2 Goals**
- ✅ No more raw file dumps - all responses synthesized
- ✅ Temporal conflicts detected and handled gracefully
- ✅ AI engineers impressed by intelligent memory consolidation
- ✅ Foundation ready for v0.1.3 BrainXchange collaboration

### **Demo Scenarios**
1. **Query**: "What's my favorite beer?"
   **Before**: [dumps 4 markdown files about beer]
   **After**: "Your beer preferences have evolved. Initially you loved IPAs (2023), but by early 2024 you found them too bitter and discovered pilsners..."

2. **Query**: "How do I debug API problems?"
   **Before**: [dumps scattered debugging notes]
   **After**: "Based on your debugging experiences, your current approach combines network inspection, logging analysis, and..."

3. **Command**: `magi nap status`
   **Output**: "Found 23 fragmented topics, 7 temporal conflicts, suggested 5 consolidations..."

## **Development Timeline**
- **Week 1**: Enhanced synthesis prompts and temporal weighting
- **Week 2**: Consolidation commands and conflict detection
- **Week 3**: REPL enhancements and testing
- **Week 4**: Polish, documentation, and release

---

*This plan transforms magi from a "fancy file search" into an intelligent memory synthesis system that will impress AI engineers and provide real value.*